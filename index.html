<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dream Mobile</title>
    <style>
        /* é€™è£¡è«‹ç›´æ¥è²¼ä¸Šæ‚¨å®šæ¡ˆç‰ˆåŸæœ‰çš„ <style> å…§å®¹ */
        :root { --primary: #4A90E2; --gold: #C1A258; --bg: #F9F9F9; }
        /* é¡å¤–åŠ å…¥ 3+N éš±è—æ¨£å¼ */
        .task-hidden { display: none !important; }
        .more-btn { color: var(--primary); font-size: 13px; font-weight: 700; text-align: center; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const SHEET_ID = urlParams.get('id');
        // ä½¿ç”¨æ‚¨æœ€æ–°çš„ API ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbwEA2bbL94YtNbunJj_Dej5UidtvExIKm28tctKsdEOUIuIdfBpNkHGCr0WXQLQzBVYew/exec";
        
        let USER_PIN = localStorage.getItem("dm_pin");

        window.onload = async () => {
            if (!SHEET_ID) return alert("âŒ ç¼ºå°‘è©¦ç®—è¡¨ ID");
            if (!USER_PIN) {
                USER_PIN = prompt("ğŸš€ è«‹è¼¸å…¥æ‚¨çš„ 4 ä½æ•¸é©—è­‰ç¢¼ï¼š");
                if (USER_PIN) localStorage.setItem("dm_pin", USER_PIN);
            }
            await loadDashboard();
        };

        // 1. è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
        async function loadDashboard() {
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch(`${API_URL}?action=getSummary&id=${SHEET_ID}&pin=${USER_PIN}`);
                const json = await res.json();
                
                if (json.status === "auth_fail") {
                    localStorage.removeItem("dm_pin");
                    location.reload(); return;
                }

                // æ›´æ–°ç•«é¢æ•¸æ“š
                document.getElementById('user-display').innerText = "æ‚¨å¥½ï¼ " + json.data.nickname;
                document.querySelector('.count-num').innerText = json.data.remainingDays;
                
                // è¼‰å…¥ä»Šæ—¥ä»»å‹™
                await loadTasks();
            } catch (e) { console.error(e); }
            document.getElementById('loading').style.display = 'none';
        }

        // 2. å¯¦ä½œ 3+N ä»»å‹™é‚è¼¯
        async function loadTasks() {
            const dateStr = new Date().toISOString().split('T')[0]; // ä»Šæ—¥æ—¥æœŸ
            const res = await fetch(`${API_URL}?action=getTasks&id=${SHEET_ID}&pin=${USER_PIN}&date=${dateStr}`);
            const json = await res.json();
            
            const list = document.getElementById('task-list');
            list.innerHTML = "";
            
            json.data.forEach((task, i) => {
                const div = document.createElement('div');
                div.className = `task-item ${task.isDone ? 'done' : ''}`;
                // ç¬¬ 4 å€‹ä»»å‹™é–‹å§‹é è¨­éš±è—
                if (i >= 3) div.classList.add('task-hidden');
                
                div.innerHTML = `
                    <div class="task-checkbox"></div>
                    <div class="task-name">${task.name}</div>
                    <div class="action-icon">âœ</div>
                `;
                list.appendChild(div);
            });

            // å¢åŠ å±•é–‹æŒ‰éˆ•
            if (json.data.length > 3) {
                const more = document.createElement('div');
                more.className = 'more-btn';
                more.innerText = `é‚„æœ‰ ${json.data.length - 3} å€‹ä»»å‹™ (é»æ“Šå±•é–‹)`;
                more.onclick = () => {
                    document.querySelectorAll('.task-hidden').forEach(el => el.classList.remove('task-hidden'));
                    more.style.display = 'none';
                };
                list.appendChild(more);
            }
        }
    </script>
</body>
</html>