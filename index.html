<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dream Mobile</title>
    <style>
        /* [é€™è£¡è«‹è²¼å…¥æ‚¨ 260111-å®šæ¡ˆç‰ˆå‰ç«¯.txt çš„æ‰€æœ‰ CSS æ¨£å¼ï¼Œæ­¤è™•çœç•¥ä»¥ä¿æŒç°¡æ½”] */
        :root { --primary: #4A90E2; --gold: #C1A258; --bg: #F9F9F9; }
        /* ... (å…¶é¤˜æ¨£å¼) ... */
        .hidden-tasks { display: none; } /* ç”¨æ–¼ 3+N éš±è—å€ */
        .expand-btn { color: var(--primary); font-size: 13px; font-weight: 700; margin: 10px 0; cursor: pointer; }
    </style>
</head>
<body>
    <div id="loading" style="display:none;"><div class="spinner"></div></div>

    <script>
        // ==========================================
        // æ ¸å¿ƒå°æ¥é‚è¼¯
        // ==========================================
        const urlParams = new URLSearchParams(window.location.search);
        const SHEET_ID = urlParams.get('id');
        const API_URL = "https://script.google.com/macros/s/AKfycbwEA2bbL94YtNbunJj_Dej5UidtvExIKm28tctKsdEOUIuIdfBpNkHGCr0WXQLQzBVYew/exec"; // å¡«å…¥éƒ¨ç½² Code.gs å¾Œæ‹¿åˆ°çš„ç¶²å€
        
        let USER_PIN = localStorage.getItem("dm_pin");
        let currentOffset = 0;

        window.onload = async () => {
            if (!SHEET_ID) {
                alert("âŒ åµæ¸¬ä¸åˆ°è©¦ç®—è¡¨ IDï¼Œè«‹ç¢ºèªç¶²å€åƒæ•¸ã€‚");
                return;
            }
            if (!USER_PIN) {
                USER_PIN = prompt("ğŸš€ æ­¡è¿å•Ÿå‹•å¤¢æƒ³æ©Ÿï¼è«‹è¼¸å…¥æ‚¨çš„ 4 ä½æ•¸é©—è­‰ç¢¼ï¼š");
                if (USER_PIN) localStorage.setItem("dm_pin", USER_PIN);
            }
            await initApp();
        };

        // 1. åˆå§‹åŒ– App ä¸¦æŠ“å–ä»Šæ—¥æ‘˜è¦ [cite: 161-165]
async function initApp() {
    toggleLoading(true);
    console.log("æ­£åœ¨å˜—è©¦é€£ç·šè‡³ API:", API_URL);
    console.log("ä½¿ç”¨çš„è©¦ç®—è¡¨ ID:", SHEET_ID);

    try {
        const res = await fetch(`${API_URL}?action=getSummary&id=${SHEET_ID}&pin=${USER_PIN}`);
        const json = await res.json();
        console.log("æ”¶åˆ°å›æ‡‰å…§å®¹:", json);
        
        if (json.status === "auth_fail") {
            alert("âš ï¸ å¯†ç¢¼é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨ C7 æ¬„ä½ã€‚");
            localStorage.removeItem("dm_pin");
            location.reload();
            return;
        }

        if (json.status === "success") {
            document.getElementById('user-display').innerText = "æ‚¨å¥½ï¼ " + json.data.nickname;
            document.querySelector('.count-num').innerText = json.data.remainingDays;
            await loadTasks();
        } else {
            alert("âš ï¸ ç³»çµ±å›å ±éŒ¯èª¤ï¼š" + json.message);
        }
    } catch (e) {
        console.error("Fetch å¤±æ•—åŸå› :", e);
        alert("âŒ é€£ç·šå¤±æ•—ï¼\n1. è«‹æª¢æŸ¥ API_URL æ˜¯å¦å¡«å°\n2. è«‹æª¢æŸ¥è©¦ç®—è¡¨æ˜¯å¦å·²è¨­ç‚ºã€Œä»»ä½•äººå¯ç·¨è¼¯ã€");
    }
    toggleLoading(false);
}

        // 2. è¼‰å…¥ä»»å‹™ä¸¦åŸ·è¡Œ 3+N é‚è¼¯ [cite: 178-181]
        async function loadTasks() {
            const dateStr = new Date().toISOString().split('T')[0]; // æš«ä»¥ä»Šæ—¥æ¸¬è©¦
            const res = await fetch(`${API_URL}?action=getTasks&id=${SHEET_ID}&pin=${USER_PIN}&date=${dateStr}`);
            const json = await res.json();
            
            if (json.status === "success") {
                renderTaskList(json.data);
            }
        }

        // 3. æ¸²æŸ“æ¸…å–® (3+N å¯¦ä½œ) [cite: 178-181]
        function renderTaskList(tasks) {
            const container = document.getElementById('task-list');
            container.innerHTML = "";
            
            tasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.className = `task-item ${task.isDone ? 'done' : ''}`;
                
                // è¶…é 3 å€‹å‰‡éš±è—
                if (index >= 3) {
                    taskEl.classList.add('hidden-tasks');
                }

                taskEl.innerHTML = `
                    <div class="task-checkbox"></div>
                    <div class="task-name">${task.name}</div>
                    <div class="action-icon">âœ</div>
                `;
                container.appendChild(taskEl);
            });

            // å¦‚æœä»»å‹™å¤§æ–¼ 3 å€‹ï¼Œå¢åŠ å±•é–‹æŒ‰éˆ•
            if (tasks.length > 3) {
                const btn = document.createElement('div');
                btn.className = 'expand-btn';
                btn.innerText = `... é‚„æœ‰ ${tasks.length - 3} å€‹ä»»å‹™ (é»æ“Šå±•é–‹)`;
                btn.onclick = () => {
                    document.querySelectorAll('.hidden-tasks').forEach(el => el.style.display = 'flex');
                    btn.style.display = 'none';
                };
                container.appendChild(btn);
            }
        }

        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>