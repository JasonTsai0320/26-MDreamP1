<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dream Mobile</title>
    <style>
        /* 樣式設定 */
        :root { --primary: #4A90E2; --bg: #F9F9F9; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; }
        .view { display: none; opacity: 0; transition: opacity 0.4s ease; }
        .view.active { display: block; opacity: 1; }
        
        /* 讀取動畫樣式 */
        #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 登入畫面樣式 */
        #login-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        #pin-input { width: 260px; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 20px; text-align: center; margin: 20px 0; }
        .btn-start { width: 260px; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; }

        /* 主畫面數據樣式 */
        .header { padding: 40px 24px; display: flex; justify-content: space-between; align-items: flex-end; }
        .count-num { font-size: 36px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div></div>

    <div id="login-screen">
        <h2 style="color:var(--primary)">夢想機 啟動</h2>
        <input type="password" id="pin-input" placeholder="請輸入 4 位數驗證碼" maxlength="4">
        <button class="btn-start" onclick="handleLogin()">進入系統</button>
    </div>

    <div id="view-home" class="view">
        <div class="header">
            <div>
                <div id="user-display" style="font-size:24px; font-weight:bold;">您好！</div>
                <div style="color:#888;">今日進度目標</div>
            </div>
            <div style="text-align:right">
                <div id="days-val" class="count-num">--</div>
                <div style="font-size:12px; color:#888;">倒數天數</div>
            </div>
        </div>
        <div id="task-list" style="padding: 0 24px;">
            </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const SHEET_ID = urlParams.get('id');
        const API_URL = "https://script.google.com/macros/s/AKfycbwEA2bbL94YtNbunJj_Dej5UidtvExIKm28tctKsdEOUIuIdfBpNkHGCr0WXQLQzBVYew/exec";
        
        let USER_PIN = localStorage.getItem("dm_pin");

        window.onload = async () => {
            if (!SHEET_ID) return alert("❌ 缺少試算表 ID");
            if (USER_PIN) await startSystem(); // 如果記住過密碼，自動登入
        };

        async function handleLogin() {
            const input = document.getElementById('pin-input');
            if (!input.value) return alert("請輸入密碼");
            USER_PIN = input.value;
            await startSystem();
        }

        async function startSystem() {
            toggleLoading(true);
            try {
                // 向 API 請求資料
                const res = await fetch(`${API_URL}?action=getSummary&id=${SHEET_ID}&pin=${USER_PIN}`);
                const json = await res.json();
                
                if (json.status === "auth_fail") {
                    alert("⚠️ 驗證失敗：密碼不正確");
                    localStorage.removeItem("dm_pin");
                    location.reload();
                    return;
                }

                // 驗證成功，儲存密碼並更新畫面
                localStorage.setItem("dm_pin", USER_PIN);
                
                // 安全填入數據，避免 null 報錯
                const userEl = document.getElementById('user-display');
                if (userEl) userEl.innerText = "您好！ " + json.data.nickname;
                
                const daysEl = document.getElementById('days-val');
                if (daysEl) daysEl.innerText = json.data.remainingDays;

                // 切換視圖
                const loginBox = document.getElementById('login-screen');
                if (loginBox) loginBox.style.display = 'none';
                
                const homeView = document.getElementById('view-home');
                if (homeView) homeView.classList.add('active');

            } catch (e) {
                console.error(e);
                alert("連線發生錯誤");
            }
            toggleLoading(false);
        }

        function toggleLoading(show) {
            const el = document.getElementById('loading');
            if (el) el.style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>