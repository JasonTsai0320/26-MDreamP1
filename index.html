<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¤¢æƒ³æ©Ÿ é™¤éŒ¯æ¨¡å¼</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f4f8; }
        .box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #view-app { display: none; } /* åˆå§‹éš±è—ï¼ŒæˆåŠŸæ‰é–‹å•Ÿ */
        .data-text { font-size: 24px; color: #4A90E2; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸš€ å¤¢æƒ³æ©Ÿ ç³»çµ±è¨ºæ–·</h1>

    <div id="login-screen" class="box">
        <h3>èº«åˆ†é©—è­‰</h3>
        <p>è«‹è¼¸å…¥ 4 ä½æ•¸é©—è­‰ç¢¼</p>
        <input type="password" id="pin-input" style="font-size:24px; width:120px; text-align:center;" maxlength="4">
        <br><br>
        <button onclick="diagnoseApp()" style="padding:10px 20px; font-size:18px; background:#4A90E2; color:white; border:none; border-radius:8px;">é€²å…¥ç³»çµ±</button>
    </div>

    <div id="view-app" class="box">
        <p>âœ… ç³»çµ±å·²å•Ÿå‹•ï¼</p>
        <div class="data-text">æš±ç¨±ï¼š<span id="name-field">--</span></div>
        <div class="data-text">å€’æ•¸ï¼š<span id="days-field">--</span> å¤©</div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const SHEET_ID = urlParams.get('id');
        // æ‚¨æ¸¬è©¦æˆåŠŸçš„ API ç¶²å€
        const API_URL = "https://script.google.com/macros/s/AKfycbwEA2bbL94YtNbunJj_Dej5UidtvExIKm28tctKsdEOUIuIdfBpNkHGCr0WXQLQzBVYew/exec";

        async function diagnoseApp() {
            const pin = document.getElementById('pin-input').value;
            if(!pin) return alert("è«‹è¼¸å…¥å¯†ç¢¼");

            alert("ã€æ­¥é©Ÿ 1ã€‘é–‹å§‹é€£ç·šè‡³ Google...");

            try {
                // ç™¼å‡ºé€£ç·šè«‹æ±‚
                const response = await fetch(`${API_URL}?action=getSummary&id=${SHEET_ID}&pin=${pin}`);
                alert("ã€æ­¥é©Ÿ 2ã€‘Google å·²å›æ‡‰ï¼Œæ­£åœ¨è§£æè³‡æ–™...");
                
                const json = await response.json();
                console.log("æ”¶åˆ°çš„åŸå§‹è³‡æ–™:", json);

                if (json.status === "success") {
                    alert("ã€æ­¥é©Ÿ 3ã€‘é©—è­‰æˆåŠŸï¼æ­£åœ¨åˆ‡æ›ç•«é¢...");
                    
                    // å¡«å…¥è³‡æ–™
                    document.getElementById('name-field').innerText = json.data.nickname;
                    document.getElementById('show-name').innerText = json.data.nickname; // é ç•™åŸæœ‰åç¨±
                    document.getElementById('name-field').innerText = json.data.nickname;
                    document.getElementById('days-field').innerText = json.data.remainingDays;

                    // åˆ‡æ›é¡¯ç¤º
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('view-app').style.display = 'block';

                    alert("ã€æ­¥é©Ÿ 4ã€‘ç•«é¢åˆ‡æ›å®Œæˆï¼æˆåŠŸæŠ“åˆ°ï¼š" + json.data.nickname);
                } else {
                    alert("âŒ é©—è­‰å¤±æ•—ï¼š" + json.message);
                }
            } catch (e) {
                alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message + "\nè«‹ç¢ºèª API æ˜¯å¦å·²é–‹å•Ÿã€Œæ‰€æœ‰äººã€å­˜å–æ¬Šé™ã€‚");
            }
        }
    </script>
</body>
</html>