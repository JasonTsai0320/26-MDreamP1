<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dream Mobile v2.0</title>
    <style>
        /* 1. 強制改變顏色，用來確認有沒有更新成功 */
        :root { --primary: #007AFF; --bg: #E3F2FD; } /* 淡藍色背景 */
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; }
        
        .header-bar { background: var(--primary); color: white; padding: 40px 20px 20px; text-align: left; border-radius: 0 0 30px 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .version-tag { background: #FF3B30; color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; float: right; }
        
        .view { display: none; padding: 20px; }
        .view.active { display: block !important; }

        /* 任務卡片樣式 */
        .task-card { background: white; margin-bottom: 15px; padding: 18px; border-radius: 20px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .circle { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%; margin-right: 15px; }
        .circle.done { background: var(--primary); border-color: var(--primary); }
    </style>
</head>
<body>

    <div id="login-view" class="view active" style="text-align:center; background:white; height:100vh; padding-top:100px;">
        <span class="version-tag">版本：正式 v2.0</span>
        <h2 style="color:var(--primary)">夢想機 啟動</h2>
        <input type="password" id="pin-input" style="width:150px; padding:15px; font-size:24px; text-align:center; border:2px solid #eee; border-radius:15px; margin:20px 0;" placeholder="••••" maxlength="4">
        <br>
        <button onclick="startApp()" style="background:var(--primary); color:white; border:none; padding:15px 50px; border-radius:15px; font-weight:bold;">驗證進入</button>
    </div>

    <div id="home-view" class="view">
        <div class="header-bar">
            <span class="version-tag">版本：正式 v2.0</span>
            <div id="name-txt" style="font-size:24px; font-weight:bold;">您好！ JP</div>
            <div style="margin-top:10px; font-size:14px; opacity:0.8;">今日剩餘挑戰</div>
            <div id="days-txt" style="font-size:48px; font-weight:bold; margin-top:5px;">76 <span style="font-size:16px;">天</span></div>
        </div>

        <h4 style="margin:25px 0 15px; color:#666;">今日任務清單</h4>
        <div id="task-container">
            </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const SHEET_ID = urlParams.get('id');
        const API_URL = "https://script.google.com/macros/s/AKfycbwEA2bbL94YtNbunJj_Dej5UidtvExIKm28tctKsdEOUIuIdfBpNkHGCr0WXQLQzBVYew/exec";
        let SAVED_PIN = localStorage.getItem("dm_pin");

        window.onload = () => { if (SAVED_PIN) startApp(); };

        async function startApp() {
            const input = document.getElementById('pin-input');
            const pin = SAVED_PIN || (input ? input.value : null);
            if (!pin) return;

            try {
                // 1. 抓取基本資料
                const res = await fetch(`${API_URL}?action=getSummary&id=${SHEET_ID}&pin=${pin}`);
                const json = await res.json();

                if (json.status === "success") {
                    localStorage.setItem("dm_pin", pin);
                    
                    // 填入資料
                    document.getElementById('name-txt').innerText = "您好！ " + json.data.nickname;
                    document.getElementById('days-txt').innerHTML = json.data.remainingDays + ' <span style="font-size:16px;">天</span>';

                    // 畫面切換
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('home-view').classList.add('active');

                    // 2. 抓取任務
                    fetchTasks(pin);
                } else {
                    alert("驗證失敗，請檢查密碼");
                    localStorage.removeItem("dm_pin");
                    location.reload();
                }
            } catch (e) { alert("連線不穩定，請重新整理"); }
        }

        async function fetchTasks(pin) {
            try {
                const res = await fetch(`${API_URL}?action=getTasks&id=${SHEET_ID}&pin=${pin}`);
                const json = await res.json();
                const container = document.getElementById('task-container');
                if (!container || json.status !== "success") return;

                container.innerHTML = "";
                json.data.forEach((t) => {
                    const card = document.createElement('div');
                    card.className = "task-card";
                    card.innerHTML = `
                        <div class="circle ${t.isDone ? 'done' : ''}"></div>
                        <div style="flex:1; ${t.isDone ? 'color:#ccc;text-decoration:line-through;' : ''}">${t.name}</div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) { console.error("任務載入失敗"); }
        }
    </script>
</body>
</html>